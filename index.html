<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Daily Data Storage</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
  .hide-pdf {
    /* hidden only when generating PDF */
  }
</style>

</head>
<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">Daily Data Storage</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a id="addTab" class="nav-link active" href="#">Add Entry</a>
        </li>
        <li class="nav-item">
          <a id="viewTab" class="nav-link" href="#">View Data</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- ADD ENTRY FORM -->
<div class="container mt-4" id="formSection">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0 fw-bold">Enter Daily Data</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Date</label>
          <input type="date" class="form-control" id="date">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Driver Name</label>
          <input type="text" class="form-control" id="driver" placeholder="Enter driver name">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Count of Packages</label>
          <input type="number" class="form-control" id="count" placeholder="No. of packages">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Village</label>
          <input type="text" class="form-control" id="village" placeholder="Village name">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Mill Name</label>
          <input type="text" class="form-control" id="millName" placeholder="Enter mill name">
        </div>
        <div class="col-12">
          <label class="form-label fw-semibold">Mill Address</label>
          <textarea class="form-control" id="millAddress" rows="2" placeholder="Full mill address"></textarea>
        </div>
      </div>
      <button class="btn btn-primary w-100 mt-3 fw-bold" onclick="saveEntry()">ðŸ’¾ Save Entry</button>
      <div id="formMessage" class="mt-2 text-center fw-bold"></div>
    </div>
  </div>
</div>

<!-- VIEW TABLE -->
<div class="container mt-4" id="tableSection" style="display:none;">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-bold">Saved Records</h5>
      <button class="btn btn-warning btn-sm" onclick="downloadPDF()">Download PDF</button>
    </div>
    <div class="card-body table-responsive">
      <div id="pdfArea">
        <div id="pdfTitle"></div>
        <table class="table table-hover align-middle">
          <thead class="table-primary text-center">
            <tr>
              <th>Date</th>
              <th>Driver</th>
              <th>Count</th>
              <th>Village</th>
              <th>Mill Name</th>
              <th>Mill Address</th>
              <th class="hide-pdf">Action</th>
            </tr>
          </thead>
          <tbody id="dataBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiURL = "https://script.google.com/macros/s/AKfycbzEDIWBRES1pn9k_Nu9-DfDjrM0u9Qp4ZHrXbNbzxCbLLvfW-covtjKg0zAN8WIdf4p/exec";
let editRowNumber = null;
let allData = []; // cached data

/* ---------------- TAB SWITCH ---------------- */
document.getElementById("addTab").onclick = () => {
  document.getElementById("formSection").style.display = "block";
  document.getElementById("tableSection").style.display = "none";
  document.getElementById("addTab").classList.add("active");
  document.getElementById("viewTab").classList.remove("active");
};

document.getElementById("viewTab").onclick = async () => {
  document.getElementById("formSection").style.display = "none";
  document.getElementById("tableSection").style.display = "block";
  document.getElementById("viewTab").classList.add("active");
  document.getElementById("addTab").classList.remove("active");
  await loadData(true);
};

/* ---------------- SPINNER ---------------- */
function showSpinner(targetId) {
  const target = document.getElementById(targetId);
  target.innerHTML = `
    <tr><td colspan="7" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </td></tr>`;
}

/* ---------------- FORMAT DATE ---------------- */
function formatDateForInput(input) {
  const d = new Date(input);
  if (isNaN(d.getTime())) return "";
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

/* ---------------- CLEAR FORM ---------------- */
function clearForm() {
  date.value = "";
  driver.value = "";
  count.value = "";
  village.value = "";
  document.getElementById("millName").value = "";
  document.getElementById("millAddress").value = "";
}

/* ---------------- LOAD DATA ---------------- */
async function loadData(force=false) {
  if(force || allData.length === 0){
    showSpinner("dataBody");
    const res = await fetch(apiURL + "?action=read");
    allData = await res.json();
  }

  const body = document.getElementById("dataBody");
  body.innerHTML = "";

  if(allData.length === 0){
    body.innerHTML = `<tr><td colspan="7" class="text-center py-3">No records found</td></tr>`;
    return;
  }

  allData.forEach((row, index) => {
    const dateStr = formatDateForInput(row.date);
    body.innerHTML += `
<tr class="text-center">
  <td>${dateStr}</td>
  <td>${row.driver}</td>
  <td>${row.count}</td>
  <td>${row.village}</td>
  <td>${row.millName}</td>
  <td>${row.millAddress}</td>
  <td>
    <div class="d-flex gap-2 justify-content-center">
      <button class="btn btn-success hide-pdf btn-sm" onclick="editRow(${index})">Edit</button>
      <button class="btn btn-danger hide-pdf btn-sm" onclick="deleteRow(${index})">Delete</button>
    </div>
  </td>
</tr>`;
  });
}

/* ---------------- SAVE ENTRY ---------------- */
async function saveEntry() {
  const millNameValue = document.getElementById("millName").value;
  const millAddressValue = document.getElementById("millAddress").value;

  if (!date.value || !driver.value || !count.value || !village.value || !millNameValue || !millAddressValue) {
    displayFormMessage("Please fill all fields", "text-danger");
    return;
  }

  const saveBtn = event.target;
  const originalText = saveBtn.innerHTML;
  saveBtn.disabled = true;
  saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

  const formData = new URLSearchParams();
  const action = editRowNumber ? "update" : "add";

  formData.append("action", action);
  formData.append("date", date.value);
  formData.append("driver", driver.value);
  formData.append("count", count.value);
  formData.append("village", village.value);
  formData.append("millName", millNameValue);
  formData.append("millAddress", millAddressValue);
  if(editRowNumber) formData.append("id", editRowNumber);

  try {
    const res = await fetch(`${apiURL}?action=${action}`, { method:"POST", body: formData });
    await res.json();

    clearForm();
    editRowNumber = null;
   

    displayFormMessage(action === "add" ? "Entry saved successfully!" : "Updated successfully!", "text-success");
  } catch (err) {
    console.error(err);
    displayFormMessage("Something went wrong. Try again.", "text-danger");
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalText;
    await loadData(true);
  }
}

/* ---------------- INLINE FORM MESSAGE ---------------- */
function displayFormMessage(msg, className){
  const messageEl = document.getElementById("formMessage");
  messageEl.innerText = msg;
  messageEl.className = `mt-2 text-center fw-bold ${className}`;
  setTimeout(() => { messageEl.innerText = ""; messageEl.className = "mt-2"; }, 3000);
}

/* ---------------- DELETE ---------------- */
async function deleteRow(index){
  if(!confirm("Are you sure to delete this entry?")) return;
  showSpinner("dataBody");
  const id = allData[index].id;
  await fetch(`${apiURL}?action=delete&id=${id}`, {method:"POST"});
  allData.splice(index,1);
  await loadData();
}

/* ---------------- EDIT ---------------- */
async function editRow(index){
  const row = allData[index];
  document.getElementById("addTab").click();
  date.value = formatDateForInput(row.date);
  driver.value = row.driver;
  count.value = row.count;
  village.value = row.village;
  document.getElementById("millName").value = row.millName;
  document.getElementById("millAddress").value = row.millAddress;
  editRowNumber = row.id;
}

/* ---------------- DOWNLOAD PDF ---------------- */
async function downloadPDF() {
  const hideEls = document.querySelectorAll(".hide-pdf");
  hideEls.forEach(el => el.style.display = "none");

  const pdfTitle = document.getElementById("pdfTitle");
  pdfTitle.innerHTML = `<h2 style="text-align:center; margin-bottom:20px;">Daily Trips Report</h2>`;

  const element = document.getElementById("pdfArea");

  await html2pdf().from(element).set({
    margin: 0.5,
    filename: "daily_trips_report.pdf",
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: "in", format: "a4" }
  }).save();

  hideEls.forEach(el => el.style.display = "");
  pdfTitle.innerHTML = "";
}

/* ---------------- INITIAL LOAD ---------------- */
window.onload = () => {
  loadData(true);
}
</script>
</body>
</html>
